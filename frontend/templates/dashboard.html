{% extends "base.html" %}
{% block title %}Dashboard · Object Detection Hub{% endblock %}
{% block content %}
<div class="row mt-4">
  <div class="col-12">
    <h1 class="h4">Dashboard</h1>
    <p class="text-muted">Statystyki wczytywane są z API (/api/stats/*).</p>
  </div>

  <div class="col-lg-6 mt-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h6">Najczęstsze klasy (globalnie)</h2>
        <canvas id="chartGlobal"></canvas>
      </div>
    </div>
  </div>

  <div class="col-lg-6 mt-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <h2 class="h6 mb-0">Trend dla klasy</h2>
          <div class="d-flex gap-2">
            <input id="cls" class="form-control form-control-sm" placeholder="np. car" style="max-width: 140px;">
            <button id="btn" class="btn btn-sm btn-outline-primary">Pokaż</button>
          </div>
        </div>
        <div class="text-muted small mt-1">Wpisz dokładną nazwę klasy (np. <span class="mono">car</span>, <span class="mono">person</span>).</div>
        <div class="mt-3">
          <canvas id="chartTs"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
let globalChart = null;
let tsChart = null;

async function loadGlobal() {
  const res = await fetch('/api/stats/classes');
  const data = await res.json();
  const labels = data.items.map(x => x.class_name);
  const values = data.items.map(x => x.count);
  const ctx = document.getElementById('chartGlobal');
  globalChart = new Chart(ctx, {
    type: 'bar',
    data: { labels: labels, datasets: [{ label: 'Liczba', data: values }]},
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

async function loadTs(className) {
  const res = await fetch(`/api/stats/timeseries?class_name=${encodeURIComponent(className)}`);
  if (!res.ok) {
    alert('Brak danych dla klasy: ' + className);
    return;
  }
  const data = await res.json();
  const labels = data.points.map(x => x.date);
  const values = data.points.map(x => x.count);
  const ctx = document.getElementById('chartTs');
  if (tsChart) tsChart.destroy();
  tsChart = new Chart(ctx, {
    type: 'line',
    data: { labels: labels, datasets: [{ label: className, data: values }]},
    options: { responsive: true }
  });
}

loadGlobal();

document.getElementById('btn').addEventListener('click', () => {
  const v = document.getElementById('cls').value.trim();
  if (v) loadTs(v);
});
</script>
{% endblock %}
